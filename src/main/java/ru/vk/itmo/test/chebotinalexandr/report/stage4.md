# Отчёт по "Этап 4. Репликация"

### Формат SSTable

В случае конфликтов, когда ноды возвращают разные ответы, был использован timestamp, таким образом
реализован last write wins. Формат SSTable был изменен для хранения timestamp.

SStable Header следующего формата:

| 8                     | 8                      | 8               |
|-----------------------|------------------------|-----------------|
| `Bloom filter length` | `Hash functions count` | `entries count` |

SStable Bloom filter следующего формата:

| 8      | 8      | ...       | 8      |
|--------|--------|-----------|--------|
| `hash_0` | `hash_1` | `hash_i...` | `hash_n` |

где `n` - размер фильтра Блума (`Bloom filter length`)

| 8 x entries count    | 8         | key size | 8           | value size | 8         |
|----------------------|-----------|----------|-------------|------------|-----------|
| `key_i offset` | `key size` | `key`      | `value size` | `value`      | `timestamp` |

где `i = 0, 1, ..., entries count`

Если же наша `entry` это `tombstone`, то `entry` записывается в следующем формате:

| 8         | key size | 8   | 8           |
|-----------|----------|-----|-------------|
| `key size` | key      | `-1` | `timestamp` |

где `-1` это tombstone tag. Таким образом в случае могилки, value не сохранится при `flush`, а `-1` подставляется на место value size.

Timestamp всегда фиксируется в мастер ноде и далее в случае proxy запроса передается вместе с proxy запросом другой ноде. 


### Latency: что с ним стало?

В дальнейших исследованиях будем использовать кластер из 3-ех нод, `ack/from = 2/3`. Порог на flush тот же самый - `4 МБ`. На прошлом этапе база без репликации давала следующие показатели (точки разладки):

|             | SYNCHRONOUS | ASYNCHRONOUS | ASYNCHRONOUS + SHARDING |
|-------------|-------------|--------------|-------------------------|
| PUT MAX RPS | 40k         | 130k         | 18 500                  |
| GET MAX RPS | 30k         | 100k         | 17 000                  |   


Детательным регулированием нагрузки с шагом в 500 rps была определена точка разладки для PUT-запросов:

```
./wrk -c 64 -d 20 -t 4 -L -R 1200 -s upsert-script.lua http://localhost:8080


  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     3.66ms    6.57ms  64.35ms   94.33%
    Req/Sec   308.50    129.79   380.00     83.33%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.82ms
 75.000%    3.10ms
 90.000%    5.54ms
 99.000%   38.02ms
 99.900%   60.45ms
 99.990%   64.32ms
 99.999%   64.38ms
100.000%   64.38ms
```

Latency сильно просел, теперь точка разладки для PUT запросов составляет всего 1200 rps. 

Точно таким же образом была определена точка разладки и для GET-запросов.