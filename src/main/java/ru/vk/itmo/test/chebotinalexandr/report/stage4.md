# Отчёт по "Этап 4. Репликация"

### Формат SSTable

В случае конфликтов, когда ноды возвращают разные ответы, был использован timestamp, таким образом
реализован last write wins. Формат SSTable был изменен для хранения timestamp.

SStable Header следующего формата:

| 8                     | 8                      | 8               |
|-----------------------|------------------------|-----------------|
| `Bloom filter length` | `Hash functions count` | `entries count` |

SStable Bloom filter следующего формата:

| 8      | 8      | ...       | 8      |
|--------|--------|-----------|--------|
| `hash_0` | `hash_1` | `hash_i...` | `hash_n` |

где `n` - размер фильтра Блума (`Bloom filter length`)

| 8 x entries count    | 8         | key size | 8           | value size | 8         |
|----------------------|-----------|----------|-------------|------------|-----------|
| `key_i offset` | `key size` | `key`      | `value size` | `value`      | `timestamp` |

где `i = 0, 1, ..., entries count`

Если же наша `entry` это `tombstone`, то `entry` записывается в следующем формате:

| 8         | key size | 8   | 8           |
|-----------|----------|-----|-------------|
| `key size` | key      | `-1` | `timestamp` |

где `-1` это tombstone tag. Таким образом в случае могилки, value не сохранится при `flush`, а `-1` подставляется на место value size.

Timestamp всегда фиксируется в мастер ноде и далее в случае proxy запроса передается вместе с proxy запросом другой ноде. 


### Latency: что с ним стало?

В дальнейших исследованиях будем использовать кластер из 3-ех нод. Порог на flush тот же самый - 4 МБ. На прошлом этапе база без репликации давала следующие показатели (точки разладки):

|             | SYNCHRONOUS | ASYNCHRONOUS | ASYNCHRONOUS + SHARDING |
|-------------|-------------|--------------|-------------------------|
| PUT MAX RPS | 40k         | 130k         | 18 500                  |
| GET MAX RPS | 30k         | 100k         | 17 000                  |   


Детательным регулированием нагрузки с шагом в 500 rps была определена точка разладки для PUT-запросов:

